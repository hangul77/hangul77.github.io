/** @license smfplayer.js 2013 - imaya / GREE Inc. [ https://github.com/gree/smfplayer.js ] The MIT License */(function() {'use strict';function n(b){throw b;}var p=void 0,q=null,s=!1;function t(b){return function(a){this[b]=a}}var u,v=this;function w(b,a){var d=b.split("."),e=v;!(d[0]in e)&&e.execScript&&e.execScript("var "+d[0]);for(var c;d.length&&(c=d.shift());)!d.length&&a!==p?e[c]=a:e=e[c]?e[c]:e[c]={}}function x(b){var a=z;function d(){}d.prototype=a.prototype;b.Z=a.prototype;b.prototype=new d};var A=v.Uint8Array!==p&&v.Uint16Array!==p&&v.Uint32Array!==p;function z(b,a,d){this.c=b;this.X=a;this.time=d}function B(b,a,d,e,c,g){z.call(this,b,a,d);this.H=e;this.w=c;this.z=g}x(B);function C(b,a,d,e){z.call(this,b,a,d);this.data=e}x(C);function D(b,a,d,e){z.call(this,b,a,d);this.data=e}x(D);function E(b,a){a=a||{};this.input=b;this.a=a.index||0}
E.prototype.parse=function(){var b=this.input,a=this.a,d=this.t={},e=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"melo"!==e&&n(Error("invalid MFi signature:"+e));d.Y=(b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++])>>>0;d.U=(b[a++]<<16|b[a++])+a;d.V=b[a++];d.W=b[a++];d.k=b[a++];this.a=a;for(var b=this.input,a=this.a,d=this.j={},c;a<this.t.U;)switch(e=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]),c=b[a++]<<8|b[a++],e){case "titl":case "copy":case "vers":case "date":case "prot":d[e]=String.fromCharCode.apply(q,
A?b.subarray(a,a+=c):b.slice(a,a+=c));break;case "sorc":d[e]=b[a++];break;case "note":d[e]=b[a++]<<8|b[a++];break;default:d[e]=A?b.subarray(a,a+=c):b.slice(a,a+=c)}this.a=a;var b=this.input,a=this.a,g,i,h,d=this.i=[],j,e=0;for(c=this.t.k;e<c;++e){g=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"trac"!==g&&n(Error("invalid track signature:"+g));g=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];g=a+g;for(j=d[e]=[];a<g;){h={};h.deltaTime=b[a++];i=b[a++];if(255!==i)h.type="note",h.subType="Note",h.voice=i>>
6,h.key=i&63,h.length=b[a++],1===this.j.note&&(i=b[a++],h.velocity=i>>2,h.octaveShift=i&3);else switch(h.type="meta",i=b[a++],i>>4){case 11:switch(i&15){case 0:h.subType="MasterVolume";h.value=b[a++];break;case 10:h.subType="DrumScale";h.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:n(Error("unknown message type:"+i.toString(16)))}break;case 12:h.subType="SetTempo";h.value={timeBase:7===(i&7)?NaN:Math.pow(2,i&7)*(0===(i&8)?6:15),tempo:b[a++]};break;case 13:switch(i&15){case 0:h.subType="Point";
h.value=b[a++];break;case 13:h.subType="Loop";h.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:h.subType="Nop";h.value=b[a++];break;case 15:h.subType="EndOfTrack";h.value=b[a++];break;default:n(Error("unkwnon message type:"+i.toString(16)))}break;case 14:switch(i&15){case 0:h.subType="InstrumentLowPart";h.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:h.subType="InstrumentHighPart";h.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:h.subType="Volume";h.value={part:b[a]>>
6,volume:b[a++]&63};break;case 3:h.subType="Valance";h.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:h.subType="PitchBend";h.value={part:b[a]>>6,value:b[a++]&63};break;case 5:h.subType="ChannelAssign";h.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:h.subType="VolumeChange";h.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:h.subType="PitchBendRange";h.value={part:b[a]>>6,value:b[a++]&63};break;case 9:h.subType="MasterCoarseTuning";h.value={part:b[a]>>6,value:b[a++]&63};break;
case 10:h.subType="Modulation";h.value={part:b[a]>>6,depth:b[a++]&63};break;default:n(Error("unkwnon message type:"+i.toString(16)))}break;case 15:switch(i&15){case 0:h.subType="EditInstrument";i=h;var l=b[a++]<<8|b[a++],l=a+l,f=[],k=p;for(1!==b[a++]&&n(Error("invalid EditInstrument const value:"+b[a-1]));a<l;)k={},k.part=b[a++]>>4&3,k.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>
4,WF:b[a]>>3&1,FB:b[a++]&7},k.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},k.octaveSelect=b[a++]&3,f.push(k);i.value=f;break;case 1:h.subType="Vibrato";i=h;a++;a++;1!==b[a++]&&n(Error("invalid Vibrato const value:"+b[a-1]));l={part:b[a++]>>5&3,"switch":b[a++]>>6};i.value=l;break;case 15:h.subType="DeviceSpecific";i=h;l=b[a++]<<8|b[a++];l=a+l;17!==b[a++]&&
n(Error("invalid DeviceSpecific const value:"+b[a-1]));l={data:A?b.subarray(a,a+=l-a):b.slice(a,a+=l-a)};i.value=l;break;default:n(Error("unkwnon message type:"+i.toString(16)))}break;default:n(Error("unkwnon message type:"+i.toString(16)))}j.push(h)}a=g}this.a=a};
function F(b){var a={timeDivision:48},d=a.tracks=[],a=a.plainTracks=[],e=b.i,c,g,i,h,j,l,f,k,m,y,r=[];for(f=0;16>f;++f)a[f]=[],r[f]=0;f=0;for(k=e.length;f<k;++f){c=e[f];h=[];j=l=m=0;for(y=c.length;m<y;++m)switch(g=c[m],j+=g.deltaTime,g.id=l,g.time=j,g.subType){case "Nop":break;case "Note":h[l++]=g;h[l]={id:l,type:"internal",subType:"NoteOff",time:j+g.length,key:g.key,voice:g.voice,velocity:g.velocity,octaveShift:g.octaveShift};l++;break;case "InstrumentHighPart":i=g;g=c[++m];"InstrumentLowPart"!==
g.subType&&n(Error("broken instrument"));h[l]={id:l,type:"internal",subType:"ProgramChange",time:j,part:g.value.part,instrument:i.value.instrument<<6|g.value.instrument};l++;break;default:h[l++]=g}h.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});d[f]=[];j=m=0;for(y=h.length;m<y;++m){g=h[m];j=g.time;switch(g.subType){case "Note":i=H(g.key+45,g.octaveShift);c=4*f+g.voice;9===c&&(i-=10);a[c].push(I(j-r[c]).concat(144|c,i,2*g.velocity));break;case "NoteOff":i=
H(g.key+45,g.octaveShift);c=4*f+g.voice;9===c&&(i-=10);a[c].push(I(j-r[c]).concat(128|c,i,2*g.velocity));break;case "ProgramChange":c=4*f+g.part;a[c].push(I(j-r[c]).concat(192|c,g.instrument));break;case "SetTempo":i=288E7/(g.value.tempo*g.value.timeBase);c=0;a[c].push(I(j-r[c]).concat(255,81,3,i>>16&255,i>>8&255,i&255));break;case "Loop":i=g.value.count;i="LOOP_"+(0===g.value.point?"START":"END")+"=ID:"+g.value.id+",COUNT:"+(0===i?-1:i);c=0;a[c].push(I(j-r[c]).concat([255,6,i.length],i.split("").map(function(a){return a.charCodeAt(0)})));
break;case "MasterVolume":i=g.value;c=0;a[c].push(I(j-r[c]).concat(240,7,127,127,4,1,i,i,247));break;case "Modulation":c=4*f+g.value.part;a[c].push(I(j-r[c]).concat(176|c,1,2*g.value.depth));break;case "Volume":c=4*f+g.value.part;a[c].push(I(j-r[c]).concat(176|c,7,2*g.value.volume));break;case "Valance":c=4*f+g.value.part;a[c].push(I(j-r[c]).concat(176|c,10,2*(g.value.valance-32)+64));break;case "PitchBend":c=4*f+g.value.part;a[c].push(I(j-r[c]).concat(224|c,2*g.value.value,2*g.value.value));break;
case "PitchBendRange":c=4*f+g.value.part;a[c].push(I(j-r[c]).concat(176|c,100,0),[0,176|c,101,0],[0,176|c,6,2*g.value.value]);break;case "MasterCoarseTuning":c=4*f+g.value.part;a[c].push(I(j-r[c]).concat(176|c,100,0),[0,176|c,101,2],[0,176|c,6,2*g.value.value]);break;default:continue}r[c]=g.time}}d=[77,84,104,100,0,0,0,6,0,1,0,16,0,48];if(b.j.copy!==p){b=b.j.copy;g=b.length;h=Array(g);for(e=0;e<g;++e)h[e]=b.charCodeAt(e);e=h;b=e.length;e=[0,255,2].concat(I(b),e);a[0].unshift(e)}g=0;for(b=a.length;g<
b;++g){f=a[g];e=[];h=0;for(j=f.length;h<j;++h)Array.prototype.push.apply(e,f[h]);j=e.length;h=[77,84,114,107,j>>24&255,j>>16&255,j>>8&255,j&255];d=d.concat(h,e)}A&&(d=new Uint8Array(d));return d}function H(b,a){var d=[0,12,-24,-12];if(d[a]!==p)return b+d[a];n(Error("invalid OctaveShift value:"+a))}function I(b){for(var a=[];128<=b;)a.unshift(b&127|(0===a.length?0:128)),b>>>=7;a.unshift(b|(0===a.length?0:128));return a};function K(b,a){a=a||{};this.input=b;this.a=a.index||0;this.length=a.length||b.length-this.a;this.offset=this.a;this.padding=a.padding!==p?a.padding:!0;this.G=a.bigEndian!==p?a.bigEndian:s}
K.prototype.parse=function(){var b=this.length+this.offset;for(this.n=[];this.a<b;){var a=this.input,d=this.a,e=p;this.n.push({type:String.fromCharCode(a[d++],a[d++],a[d++],a[d++]),size:e=this.G?(a[d++]<<24|a[d++]<<16|a[d++]<<8|a[d++])>>>0:(a[d++]|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,offset:d});d+=e;this.padding&&1===(d-this.offset&1)&&d++;this.a=d}};function L(b,a){var d=b.n[a];return d===p?q:d};function M(b,a){a=a||{};a.padding=s;a.bigEndian=!0;this.input=b;this.a=a.index||0;this.m=0;this.l=new K(b,a);this.i=[];this.A=[]}M.prototype.parse=function(){var b,a;this.l.parse();b=L(this.l,this.m++);a=this.input;var d=b.offset;(!b||"MThd"!==b.type)&&n(Error("invalid header signature"));this.I=a[d++]<<8|a[d++];this.k=a[d++]<<8|a[d++];this.T=a[d++]<<8|a[d++];b=0;for(a=this.k;b<a;++b)N(this)};
function N(b){function a(){var a=0,b;do b=e[c++],a=a<<7|b&127;while(0!==(b&128));return a}var d=L(b.l,b.m++),e=b.input,c=d.offset,g,i,h,j=-1,l=-1,f,k=0,m,y;(!d||"MTrk"!==d.type)&&n(Error("invalid header signature"));for(var d=d.offset+d.size,r=[],J=[];c<d;){g=a();k+=g;m=c;y=e[c++];i=y>>4&15;h=y&15;8>i?(i=j,h=l,y=j<<4|l,c--,m--):(j=i,l=h);var G=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(i){case 8:case 9:case 10:case 11:case 13:case 14:f=
new B(G[i],g,k,h,e[c++],e[c++]);break;case 12:f=new B(G[i],g,k,h,e[c++]);break;case 15:switch(h){case 0:f=a();247!==e[c+f-1]&&n(Error("invalid SysEx event"));f=new C("SystemExclusive",g,k,A?e.subarray(c,(c+=f)-1):e.slice(c,(c+=f)-1));break;case 7:f=a();f=new C("SystemExclusive(F7)",g,k,A?e.subarray(c,c+=f):e.slice(c,c+=f));break;case 15:i=e[c++];f=a();switch(i){case 0:f=new D("SequenceNumber",g,k,[e[c++],e[c++]]);break;case 1:f=new D("TextEvent",g,k,[String.fromCharCode.apply(q,A?e.subarray(c,c+=
f):e.slice(c,c+=f))]);break;case 2:f=new D("CopyrightNotice",g,k,[String.fromCharCode.apply(q,A?e.subarray(c,c+=f):e.slice(c,c+=f))]);break;case 3:f=new D("SequenceTrackName",g,k,[String.fromCharCode.apply(q,A?e.subarray(c,c+=f):e.slice(c,c+=f))]);break;case 4:f=new D("InstrumentName",g,k,[String.fromCharCode.apply(q,A?e.subarray(c,c+=f):e.slice(c,c+=f))]);break;case 5:f=new D("Lyrics",g,k,[String.fromCharCode.apply(q,A?e.subarray(c,c+=f):e.slice(c,c+=f))]);break;case 6:f=new D("Marker",g,k,[String.fromCharCode.apply(q,
A?e.subarray(c,c+=f):e.slice(c,c+=f))]);break;case 7:f=new D("CuePoint",g,k,[String.fromCharCode.apply(q,A?e.subarray(c,c+=f):e.slice(c,c+=f))]);break;case 32:f=new D("MidiChannelPrefix",g,k,[e[c++]]);break;case 47:f=new D("EndOfTrack",g,k,[]);break;case 81:f=new D("SetTempo",g,k,[e[c++]<<16|e[c++]<<8|e[c++]]);break;case 84:f=new D("SmpteOffset",g,k,[e[c++],e[c++],e[c++],e[c++],e[c++]]);break;case 88:f=new D("TimeSignature",g,k,[e[c++],e[c++],e[c++],e[c++]]);break;case 89:f=new D("KeySignature",g,
k,[e[c++],e[c++]]);break;case 127:f=new D("SequencerSpecific",g,k,[A?e.subarray(c,c+=f):e.slice(c,c+=f)]);break;default:f=new D("Unknown",g,k,[i,A?e.subarray(c,c+=f):e.slice(c,c+=f)])}break;default:v.console.log("unknown message:",y.toString(16))}break;default:n(Error("invalid status"))}g=c-m;m=A?e.subarray(m,m+g):e.slice(m,m+g);m[0]=y;f instanceof B&&("NoteOn"===f.c&&0===f.z)&&(f.c=G[8],m=[128|f.H,f.w,f.z],A&&(m=new Uint8Array(m)));J.push(m);r.push(f)}b.i.push(r);b.A.push(J)};function O(){this.f=5E5;this.h=s;this.position=0;this.r=this.s=this.q=this.p=s;this.F=1;this.v=16383}u=O.prototype;u.N=t("p");u.O=t("q");u.Q=t("s");u.P=t("r");u.stop=function(){var b,a;this.pause=!0;this.e=Date.now();if(this.b){b=this.b.contentWindow;for(a=0;16>a;++a)b.postMessage("midi,b"+a.toString(16)+",78,0","*")}};u.L=function(){return this.b};
function P(b){b.stop();b.f=5E5;b.position=0;b.pause=s;b.g=q;b.e=-1;b.B=q;b.C=q;b.o=q;clearTimeout(b.d);b.h?Q(b):window.addEventListener("message",function(a){"link,ready"===a.data&&Q(b)},s)}u.play=function(){var b=this;this.b||n(Error("WebMidiLink not found"));this.h?(this.g instanceof Array&&this.position>=this.g.length&&(this.position=0),R(this)):window.addEventListener("message",function(a){"link,ready"===a.data&&(b.h=!0,R(b))},s)};
function Q(b){b=b.b.contentWindow;var a;for(a=0;16>a;++a)b.postMessage("midi,b"+a.toString(16)+",07,64","*"),b.postMessage("midi,b"+a.toString(16)+",0a,40","*"),b.postMessage("midi,b"+a.toString(16)+",64,00","*"),b.postMessage("midi,b"+a.toString(16)+",65,00","*"),b.postMessage("midi,b"+a.toString(16)+",06,02","*"),b.postMessage("midi,b"+a.toString(16)+",26,00","*"),b.postMessage("midi,b"+a.toString(16)+",79,00","*")}
u.S=function(b){var a=this,d;this.b&&(document.body.removeChild(this.b),this.b=q);d=this.b=document.createElement("iframe");d.src=b||"http://www.g200kg.com/en/docs/gmplayer/";document.body.appendChild(d);window.addEventListener("message",function(b){"link,ready"===b.data&&(a.h=!0,a.D(a.v))},s)};u.D=function(b){var a;this.v=b;this.b&&(a=this.b.contentWindow,a.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(b&127).toString(16)).substr(-2),("0"+(b>>7&127).toString(16)).substr(-2),"7f"].join(),"*"))};u.R=t("F");
function R(b){function a(){var b=c[i].time,l=c.length,f,k,m=Date.now();if(d.pause)d.e=Date.now()-d.e;else{do{f=c[i].event;"SetTempo"===f.c&&(d.f=f.data[0]);"ControlChange"===f.c&&111===f.w&&(h[0]={pos:i});if("Marker"===f.c&&("A"===f.data[0]&&(h[0]={pos:i}),"B"===f.data[0]&&d.q&&h[0]&&"number"===typeof h[0].pos)){i=h[0].pos;d.d=setTimeout(a,0);d.position=i;return}if("Marker"===f.c&&(f=f.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===f[1])h[f[2]|0]=h[f[2]]||{pos:i,count:f[3]|
0};else if("END"===f[1]&&d.s){k=h[f[2]|0];if(0!==k.count){0<k.count&&k.count--;i=k.pos;d.d=setTimeout(a,0);d.position=i;return}h[f[2]|0]=q}g.postMessage(c[i++].webMidiLink,"*")}while(i<l&&c[i].time===b);i<l?(m=Date.now()-m,d.d=setTimeout(a,d.f/(1E3*e)*(c[i].time-b-m)*(1/d.F))):d.p&&h[0]&&"number"===typeof h[0].pos?(i=h[0].pos,d.d=setTimeout(a,0)):d.r&&(b=d,b.f=5E5,b.position=0,R(d));d.position=i}}var d=b,e=b.B.T,c=b.g,g=b.b.contentWindow,i=b.position||0,h=[];b.pause?(b.d=setTimeout(a,b.e),b.pause=
s,b.e=-1):b.d=setTimeout(a,b.f/1E3*e*b.g[0].time)}
u.u=function(b){b=new M(b);P(this);b.parse();var a=this.g=[],d,e,c,g=this.o=[],i,h,j,l;e=b.i;d=Array(e.length);c=b.A;i=0;for(h=e.length;i<h;++i)d[i]=0;i=0;for(h=e.length;i<h;++i){d=e[i];j=0;for(l=d.length;j<l;++j)0===b.I&&"SequenceTrackName"===d[j].c&&(this.C=d[j].data[0]),"CopyrightNotice"===d[j].c&&g.push(d[j].data[0]),a.push({track:i,eventId:j,time:d[j].time,event:d[j],webMidiLink:"midi,"+Array.prototype.map.call(c[i][j],function(a){return a.toString(16)}).join(",")})}a.sort(function(a,b){return a.time>
b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});this.B=b};u.M=function(b){b=new E(b);P(this);b.parse();this.u(F(b))};u.K=function(){return this.C};u.J=function(){return this.o};w("SMF.Player",O);w("SMF.Player.prototype.play",O.prototype.play);w("SMF.Player.prototype.stop",O.prototype.stop);w("SMF.Player.prototype.loadMidiFile",O.prototype.u);w("SMF.Player.prototype.loadMldFile",O.prototype.M);w("SMF.Player.prototype.setLoop",O.prototype.P);w("SMF.Player.prototype.setCC111Loop",O.prototype.N);w("SMF.Player.prototype.setFalcomLoop",O.prototype.O);w("SMF.Player.prototype.setMFiLoop",O.prototype.Q);w("SMF.Player.prototype.setWebMidiLink",O.prototype.S);
w("SMF.Player.prototype.getWebMidiLink",O.prototype.L);w("SMF.Player.prototype.setTempoRate",O.prototype.R);w("SMF.Player.prototype.setMasterVolume",O.prototype.D);w("SMF.Player.prototype.getCopyright",O.prototype.J);w("SMF.Player.prototype.getSequenceName",O.prototype.K);}).call(this); //@ sourceMappingURL=smfplayer.min.js.map
